<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ Festive Village Live ğŸ…</title>
    <style>
        /* --- 0. å…¨å±€è®¾ç½® --- */
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Noto+Sans+SC:wght@400;700&display=swap');

        :root {
            /* ç»å…¸çš„æ¢¦å¹»æ—¥è½èƒŒæ™¯ */
            --bg-gradient: linear-gradient(to bottom, #2b1055, #7597de 50%, #d99c79 80%, #203a43);
            --xmas-red: #D62828;
            --xmas-gold: #FCBF49;
            --panel-bg: rgba(255, 255, 255, 0.15);
        }

        body {
            margin: 0; height: 100vh; background: var(--bg-gradient);
            font-family: 'Fredoka One', 'Noto Sans SC', sans-serif; color: #fff;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }

        /* --- æ–°å¢ï¼šå°é¢é¦–é¡µæ ·å¼ --- */
        .landing-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #312A6C, #8567F5, #E68E6D); /* ä»¿ç…§å›¾ç‰‡çš„æ¸å˜ */
            z-index: 2000; /* æœ€é«˜å±‚çº§ */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        
        .landing-page.hidden {
            opacity: 0; pointer-events: none; transform: scale(1.1);
        }

        .landing-title-row {
            display: flex; align-items: center; gap: 20px; margin-bottom: 50px;
        }
        
        .landing-title {
            font-size: 60px; text-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-family: 'Fredoka One', cursive; letter-spacing: 2px;
        }
        
        .landing-emoji { font-size: 60px; animation: bounce 2s infinite alternate; }
        
        .enter-btn {
            background: #C6362C; /* å›¾ç‰‡é‡Œçš„çº¢ */
            color: #fff;
            font-family: 'Noto Sans SC', sans-serif;
            font-size: 24px; padding: 15px 60px;
            border-radius: 50px; border: none; cursor: pointer;
            box-shadow: 0 10px 20px rgba(198, 54, 44, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            letter-spacing: 2px;
        }
        
        .enter-btn:hover { transform: scale(1.05); box-shadow: 0 15px 30px rgba(198, 54, 44, 0.6); }
        .enter-btn:active { transform: scale(0.95); }

        /* --- 1. æ°›å›´ç»„ --- */
        .santa-sleigh-flying {
            position: absolute; top: 5%; right: -20%; font-size: 50px;
            animation: flyOver 35s linear infinite; opacity: 0.8; z-index: 2;
        }
        @keyframes flyOver { 0% { right: -20%; transform: rotate(5deg) scale(0.8); } 100% { right: 120%; transform: rotate(-5deg) scale(0.8); } }

        .reindeer-wrapper {
            position: absolute; bottom: 30px; left: -15%; z-index: 5;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
            animation: runAcrossScreen 24s linear infinite;
        }
        .reindeer-body {
            font-size: 60px; display: block;
            animation: gallopBounce 0.4s ease-in-out infinite alternate, faceDirection 24s steps(1) infinite; 
        }
        @keyframes runAcrossScreen { 0% { left: -15%; } 49.9% { left: 105%; } 50.1% { left: 105%; } 100% { left: -15%; } }
        @keyframes faceDirection { 0% { transform: scaleX(-1); } 50% { transform: scaleX(1); } 100% { transform: scaleX(-1); } }
        @keyframes gallopBounce { from { transform: translateY(0); } to { transform: translateY(-15px); } }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-15px); } }
        
        .snowflake { 
            position: absolute; top: -20px; color: #fff; 
            animation: fall linear infinite; pointer-events: none; opacity: 0.8; z-index: 2001; /* è®©é›ªèŠ±åœ¨å°é¢ä¹‹ä¸Š */
        }
        @keyframes fall { to { transform: translateY(110vh); } }

        /* --- 2. ä¸»å¸ƒå±€ --- */
        .app-container {
            width: 98%; max-width: 1400px; height: 92vh;
            display: grid; 
            grid-template-columns: 280px 1fr 300px; 
            gap: 20px; z-index: 10;
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px; padding: 20px;
            display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            height: 100%; box-sizing: border-box; overflow: hidden; min-height: 0;
        }
        .panel-title {
            text-align: center; color: var(--xmas-gold); font-size: 18px; margin-bottom: 15px;
            border-bottom: 1px dashed rgba(255,255,255,0.3); padding-bottom: 10px; flex-shrink: 0; 
        }

        /* --- 3. ä¸­é—´èˆå° --- */
        .center-stage {
            position: relative; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
        }
        
        .stage-header {
            position: absolute; top: 15px; z-index: 60;
            display: flex; align-items: center; gap: 15px; left: 50%; transform: translateX(-50%);
        }

        .tree-title-display {
            font-size: 32px; color: var(--xmas-gold);
            text-shadow: 0 0 10px rgba(0,0,0,0.8); transition: 0.5s;
            background: rgba(0,0,0,0.4); padding: 5px 25px; border-radius: 50px;
            border: 1px solid rgba(255,215,0,0.3); white-space: nowrap;
        }

        .bgm-btn {
            width: 45px; height: 45px;
            background: rgba(0,0,0,0.4); color: white; border-radius: 50%; font-size: 20px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            border: 2px solid var(--xmas-gold); transition: 0.2s;
            animation: bellShake 3s infinite;
        }
        .bgm-btn:hover { transform: scale(1.1); background: var(--xmas-red); }
        .bgm-btn.playing { background: var(--xmas-red); animation: none; box-shadow: 0 0 15px var(--xmas-red); }
        @keyframes bellShake { 0%,100%{transform:rotate(0)} 10%{transform:rotate(15deg)} 20%{transform:rotate(-15deg)} 30%{transform:rotate(10deg)} 40%{transform:rotate(-10deg)} 50%{transform:rotate(0)} }

        .nav-btn {
            position: absolute; top: 50%; width: 50px; height: 50px;
            background: rgba(0,0,0,0.4); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; border: 2px solid rgba(255,255,255,0.3);
            z-index: 60; transition: 0.2s; user-select: none;
        }
        .nav-btn:hover { background: var(--xmas-red); border-color: var(--xmas-gold); transform: scale(1.1); }
        .prev-btn { left: 10px; } .next-btn { right: 10px; }

        .tree-wrapper {
            position: relative; width: 420px; height: 600px; margin-bottom: 80px; box-sizing: border-box;
        }

        .tree-slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: flex-end;
            opacity: 0; transition: opacity 1.5s ease-in-out, transform 1.5s ease-in-out;
            transform: scale(0.95); pointer-events: none;
        }
        .tree-slide.active { opacity: 1; transform: scale(1); pointer-events: all; z-index: 10; }

        /* --- 4. CSS æ ‘ --- */
        .tree-css {
            position: relative; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            filter: drop-shadow(0 20px 30px rgba(0,0,0,0.6));
            animation: floatTree 6s ease-in-out infinite;
        }
        @keyframes floatTree { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

        .star-top {
            position: absolute; top: 10px; font-size: 70px; z-index: 50;
            background: linear-gradient(to bottom, #fff, #ffd700);
            -webkit-background-clip: text; color: transparent;
            filter: drop-shadow(0 0 20px #ffd700); animation: starPulse 2s infinite alternate;
        }
        @keyframes starPulse { from{transform:scale(1);} to{transform:scale(1.2);} }

        .tree-layer {
            width: 0; height: 0; border-left: solid transparent; border-right: solid transparent; border-bottom: solid; 
            position: absolute; border-radius: 20px;
        }
        .l1 { border-width: 0 65px 85px 65px; top: 60px; z-index: 12; }
        .l2 { border-width: 0 85px 95px 85px; top: 100px; z-index: 11; }
        .l3 { border-width: 0 105px 105px 105px; top: 150px; z-index: 10; }
        .l4 { border-width: 0 125px 115px 125px; top: 200px; z-index: 9; }
        .l5 { border-width: 0 145px 125px 145px; top: 250px; z-index: 8; }
        .l6 { border-width: 0 165px 135px 165px; top: 300px; z-index: 7; }
        .l7 { border-width: 0 185px 145px 185px; top: 350px; z-index: 6; }
        .l8 { border-width: 0 205px 155px 205px; top: 400px; z-index: 5; }
        .l9 { border-width: 0 225px 165px 225px; top: 450px; z-index: 4; }
        .l10 { border-width: 0 245px 175px 245px; top: 500px; z-index: 3; }
        
        .tree-stump { 
            position: absolute; bottom: -20px; width: 80px; height: 70px; 
            background: repeating-linear-gradient(90deg, #3E2723 0, #3E2723 10px, #2d1b18 10px, #2d1b18 15px);
            z-index: 1; border-radius: 5px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .t-classic .tree-layer { border-bottom-color: #1B5E20; } .t-classic .l1, .t-classic .l2 { border-bottom-color: #2E7D32; }
        .t-ice .tree-layer { border-bottom-color: #0288D1; } .t-ice .l1, .t-ice .l2 { border-bottom-color: #B3E5FC; } .t-ice .l4, .t-ice .l5 { border-bottom-color: #4FC3F7; }
        .t-magic .tree-layer { border-bottom-color: #7B1FA2; } .t-magic .l1, .t-magic .l2 { border-bottom-color: #F8BBD0; } .t-magic .l4, .t-magic .l5 { border-bottom-color: #F48FB1; }

        /* --- 5. ç¤¼ç‰©ç›’ --- */
        .box-wrapper { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 20; }
        .box {
            width: 58px; height: 58px; position: absolute; cursor: pointer;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, var(--xmas-red));
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5), inset 0 0 10px rgba(0,0,0,0.2);
            transition: all 0.3s; display: flex; justify-content: center; align-items: center;
        }
        .box::before { content:''; position: absolute; width: 12px; height: 100%; background: var(--xmas-gold); }
        .box::after { content:''; position: absolute; height: 12px; width: 100%; background: var(--xmas-gold); }
        .bow { position: absolute; top: -5px; width: 20px; height: 12px; background: var(--xmas-gold); border-radius: 50%; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        .box:hover { transform: scale(1.15) rotate(5deg); z-index: 30; box-shadow: 0 0 20px var(--xmas-gold); }
        
        .box.opened {
            background: #444; box-shadow: inset 0 0 10px #000; border: 2px solid #666;
            cursor: default; pointer-events: none; transform: scale(1); opacity: 0.9;
        }
        .box.opened::before, .box.opened::after, .box.opened .bow { display: none; }
        .box.disabled:not(.opened) { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }

        .pos0 { top: 170px; left: 220px; } .pos1 { top: 250px; left: 180px; transform: rotate(-10deg); }
        .pos2 { top: 270px; left: 280px; transform: rotate(10deg); } .pos3 { top: 340px; left: 140px; }
        .pos4 { top: 350px; left: 320px; transform: rotate(-5deg); } .pos5 { top: 370px; left: 230px; transform: rotate(8deg); }
        .pos6 { top: 440px; left: 100px; transform: rotate(15deg); } .pos7 { top: 450px; left: 360px; transform: rotate(-12deg); }
        .pos8 { top: 480px; left: 200px; }

        /* --- 6. å³ä¾§ï¼šèŠå¤© --- */
        .scroll-list { flex: 1; overflow-y: auto; margin-bottom: 10px; padding-right: 5px; min-height: 0; }
        .scroll-list::-webkit-scrollbar { width: 4px; background: rgba(0,0,0,0.2); }
        .scroll-list::-webkit-scrollbar-thumb { background: var(--xmas-gold); border-radius: 2px; }

        .chat-row { display: flex; align-items: flex-start; margin-bottom: 10px; animation: fadeIn 0.3s; }
        .chat-av { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; border: 1px solid var(--xmas-gold); cursor: pointer; background-size: cover; background-position: center; }
        .chat-bubble { background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 8px; font-size: 13px; flex: 1; word-break: break-word; }
        .chat-name { color: var(--xmas-gold); font-weight: bold; font-size: 12px; margin-bottom: 2px; cursor: pointer; }
        
        .chat-row.chief .chat-name { color: #00e676; } 
        .chat-row.chief .chat-bubble { background: rgba(255,255,255,0.1); color: #ddd; font-size: 12px; font-style: italic; }
        .chat-av.chief-av { border: none; background: none; font-size: 28px; line-height: 32px; text-align: center; }

        .chat-input-row { display: flex; gap: 5px; flex-shrink: 0; margin-top: auto; }
        .chat-inp { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: inherit; outline: none; }
        
        /* --- 7. å·¦ä¾§ï¼šæ¦œå• --- */
        .rank-item { display: flex; align-items: center; padding: 8px; margin-bottom: 8px; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .rank-item:hover { background: rgba(255,255,255,0.25); }
        .av-small { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--xmas-gold); margin-right: 8px; flex-shrink: 0; background-size: cover; }

        /* --- 8. å¼¹çª— --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-card { background: #F8F2E4; color: #333; padding: 30px; border-radius: 20px; width: 400px; border: 4px solid var(--xmas-red); text-align: center; position: relative; }
        .btn-main { background: var(--xmas-red); color: white; border: none; padding: 10px 30px; border-radius: 50px; font-size: 16px; cursor: pointer; box-shadow: 0 4px 0 #8a1010; }
        .btn-main:active { transform: translateY(3px); box-shadow: none; }
        .my-profile-btn { position: absolute; top: 20px; right: 20px; z-index: 100; background: rgba(0,0,0,0.5); padding: 8px 15px; border-radius: 30px; cursor: pointer; display: flex; align-items: center; gap: 10px; border: 1px solid var(--xmas-gold); }

        .gender-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; }
        .gender-opt { cursor: pointer; padding: 8px 20px; border: 1px solid #ccc; border-radius: 20px; background: #fff; transition: 0.2s; }
        .gender-opt.selected { background: var(--xmas-gold); border-color: #d4a000; font-weight: bold; }

        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; justify-items: center; }
        .av-select { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .av-select.selected { border-color: var(--xmas-gold); transform: scale(1.1); }

        .p0 { background: repeating-linear-gradient(45deg, #b71c1c 0, #b71c1c 10px, #1b5e20 10px, #1b5e20 20px); }
        .p1 { background: repeating-linear-gradient(90deg, #0d47a1 0, #0d47a1 15px, #ffffff 15px, #ffffff 30px); }
        .p2 { background: radial-gradient(circle, gold 2px, transparent 3px), #1a1a1a; background-size: 10px 10px; }
        .p3 { background: repeating-linear-gradient(-45deg, #1b5e20 0, #1b5e20 5px, #ffffff 5px, #ffffff 10px); }
        .p4 { background: linear-gradient(to right, #ff8a80, #ffffff, #80d8ff); }
        .p5 { background: repeating-linear-gradient(0deg, #5d4037 0, #5d4037 10px, #8d6e63 10px, #8d6e63 20px); }
        .p6 { background: repeating-linear-gradient(45deg, #7b1fa2 0, #7b1fa2 10px, #e1bee7 10px, #e1bee7 20px); }
        .p7 { background: repeating-radial-gradient(circle, #D32F2F 0, #D32F2F 5px, #ffffff 5px, #ffffff 10px); }

        @keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }
    </style>
</head>
<body>

    <div class="landing-page" id="landing-page">
        <div class="landing-title-row">
            <div class="landing-emoji">ğŸ„</div>
            <div class="landing-title">Festive Village Live</div>
            <div class="landing-emoji">ğŸ…</div>
        </div>
        <button class="enter-btn" onclick="enterVillage()">âœ¨ è¿›å…¥æ‘åº„ âœ¨</button>
    </div>

    <div class="santa-sleigh-flying">ğŸ…ğŸ›·</div>
    <div class="reindeer-wrapper"><span class="reindeer-body">ğŸ¦Œ</span></div>
    
    <div class="my-profile-btn" onclick="openMyProfile()">
        <div class="av-small p0" id="top-avatar"></div>
        <span id="top-name">æœªç™»è®°</span>
    </div>

    <div class="app-container">
        <div class="panel">
            <div class="panel-title">ğŸ“œ ç¤¼ç‰©åŠ¨æ€æ¦œ</div>
            <div class="scroll-list" id="rank-list"></div>
            <div style="font-size:12px; text-align:center; opacity:0.7; flex-shrink:0; padding-top:5px;">* ç‚¹å‡»å¤´åƒæŸ¥çœ‹èµ„æ–™</div>
        </div>

        <div class="center-stage" id="stage" onmouseenter="stopAutoSlide()" onmouseleave="startAutoSlide()">
            <div class="stage-header">
                <div class="tree-title-display" id="tree-name-display">ğŸ„ ç»å…¸ä¹‹æ£®</div>
                <div class="bgm-btn" id="bgm-btn" onclick="toggleBGM()">ğŸ””</div>
            </div>
            <div class="nav-btn prev-btn" onclick="moveSlide(-1)">â®</div>
            <div class="nav-btn next-btn" onclick="moveSlide(1)">â¯</div>
            <div class="tree-wrapper" id="track"></div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ’¬ å¹¿åœºçƒ­èŠ</div>
            <div class="scroll-list" id="chat-list"></div>
            <div class="chat-input-row">
                <input type="text" class="chat-inp" id="chat-inp" placeholder="é€å»ç¥ç¦..." onkeypress="if(event.key==='Enter') sendChat()">
                <button class="btn-main" style="padding:0 20px;" onclick="sendChat()">å‘é€</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-reg">
        <div class="modal-card">
            <h2 style="color:var(--xmas-red)">ğŸ… æ¬¢è¿å›åˆ°åœ£è¯æ‘</h2>
            <p>è¯·é€‰æ‹©ä½ çš„æ ¼çº¹æ ‡å¿—</p>
            <div class="avatar-grid">
                <div class="av-select p0" onclick="selAv(0)"></div>
                <div class="av-select p1" onclick="selAv(1)"></div>
                <div class="av-select p2" onclick="selAv(2)"></div>
                <div class="av-select p3" onclick="selAv(3)"></div>
                <div class="av-select p4" onclick="selAv(4)"></div>
                <div class="av-select p5" onclick="selAv(5)"></div>
                <div class="av-select p6" onclick="selAv(6)"></div>
                <div class="av-select p7" onclick="selAv(7)"></div>
            </div>
            <div class="gender-row">
                <div class="gender-opt selected" id="g-boy" onclick="selGender('boy')">ğŸ‘¦ ç”·ç”Ÿ</div>
                <div class="gender-opt" id="g-girl" onclick="selGender('girl')">ğŸ‘§ å¥³ç”Ÿ</div>
            </div>
            <input id="inp-name" type="text" placeholder="æ˜µç§°" style="width:80%; padding:10px; margin-bottom:10px;">
            <input id="inp-bio" type="text" placeholder="å®£è¨€" style="width:80%; padding:10px; margin-bottom:20px;">
            <button class="btn-main" onclick="register()">æ•²é—¨è¿›å…¥</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-prize">
        <div class="modal-card">
            <h2 style="color:var(--xmas-gold)">âœ¨ æƒŠå–œæ‹†ç®± âœ¨</h2>
            <div id="prize-icon" style="font-size:70px; margin:20px 0;"></div>
            <div id="prize-name" style="font-size:20px; font-weight:bold; margin-bottom:20px;"></div>
            <div id="retry-hint" style="color:green; display:none; margin-bottom:10px;">è·å¾—ã€æ—¶å…‰èƒ¶å›Šã€‘ï¼æœºä¼š+1</div>
            <button class="btn-main" onclick="closeModal('modal-prize')">æ”¶å…¥èƒŒåŒ…</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-prof">
        <div class="modal-card">
            <div style="position:absolute; top:10px; right:15px; cursor:pointer;" onclick="closeModal('modal-prof')">âœ•</div>
            <div id="prof-av" class="av-small" style="width:70px; height:70px; margin:0 auto 10px auto; border-width:3px;"></div>
            <h3 id="prof-name"></h3>
            <p id="prof-gender" style="font-size:14px; margin-top:-10px;"></p>
            <p id="prof-bio" style="font-style:italic; color:#666; background:#eee; padding:5px; border-radius:5px;"></p>
            <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
            <h4 id="prof-bag-title">ğŸ’ èƒŒåŒ…</h4>
            <div id="prof-bag" style="display:grid; grid-template-columns:repeat(3,1fr); gap:5px; max-height:150px; overflow-y:auto;"></div>
            <div id="my-controls" style="display:none; margin-top:15px; border-top:1px solid #ccc; padding-top:10px;">
                <p style="font-size:12px; color:#aaa;">ç‚¹å‡»ç¤¼ç‰©å¯èµ é€</p>
                <p>å‰©ä½™æœºä¼š: <span id="my-chances" style="font-weight:bold; color:var(--xmas-red)">0</span></p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-give">
        <div class="modal-card">
            <h3>ğŸ èµ é€ç¤¼ç‰©</h3>
            <p>è¦æŠŠ <span id="give-name" style="color:var(--xmas-red); font-weight:bold;"></span> é€ç»™è°ï¼Ÿ</p>
            <div id="give-list" style="text-align:left; max-height:150px; overflow-y:auto; margin:15px 0; background:#fff;"></div>
            <button class="btn-main" style="background:#666;" onclick="closeModal('modal-give')">å–æ¶ˆ</button>
        </div>
    </div>

    <audio id="bgm" loop><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3" type="audio/mp3"></audio>

    <script>
        const trees = [
            { name: "ğŸ„ å¿«ä¹ä¸–ä¿—", color: "#4CAF50", class: "t-classic", gifts: [
                {i:"ğŸ’°", n:"æš´å¯Œ"}, {i:"ğŸ§§", n:"å¹´ç»ˆå¥–ç¿»å€"}, {i:"ğŸŠ", n:"å¤§å‰å¤§åˆ©"}, {i:"ğŸ ", n:"å…¨æ¬¾ä¹°æˆ¿"}, {i:"ğŸš—", n:"å–œææ–°è½¦"}, {i:"ğŸ’³", n:"éšä¾¿åˆ·"}
            ]},
            { name: "â„ï¸ ç²¾ç¥çŠ¶æ€", color: "#29B6F6", class: "t-ice", gifts: [
                {i:"ğŸ˜´", n:"ç¡çœ å……è¶³"}, {i:"ğŸ§˜", n:"æ¾å¼›æ„Ÿ"}, {i:"ğŸï¸", n:"å¸¦è–ªä¼‘å‡"}, {i:"â¤ï¸", n:"è¢«çˆ±"}, {i:"âœ¨", n:"å¥½è¿çˆ†æ£š"}, {i:"ğŸ•Šï¸", n:"è‡ªç”±"}
            ]},
            { name: "ğŸ”® é­”æ³•æ‰“å·¥", color: "#9C27B0", class: "t-magic", gifts: [
                {i:"â³", n:"æ—¶å…‰å€’æµ (å†æŠ½ä¸€æ¬¡)", type:'retry'}, {i:"ğŸ’‡â€â™€ï¸", n:"å‘é‡æƒŠäºº"}, {i:"ğŸ›", n:"æ°¸æ— Bug"}, {i:"ğŸ•”", n:"å‡†ç‚¹ä¸‹ç­"}, {i:"âš–ï¸", n:"ç‹‚åƒä¸èƒ–"}, {i:"ğŸ±", n:"çŒ«ç‹—åŒå…¨"}
            ]}
        ];
        const boxPos = [
            {t:170,l:220}, {t:250,l:180}, {t:270,l:280}, {t:340,l:140}, {t:350,l:320}, 
            {t:370,l:230}, {t:440,l:100}, {t:450,l:360}, {t:480,l:200}
        ];

        let state = JSON.parse(localStorage.getItem('v18_state')) || {
            opened: {0:[], 1:[], 2:[]},
            history: [],
            chats: [{n:"æ‘é•¿", t:"æ¬¢è¿ï¼æ¯4ç§’è‡ªåŠ¨åˆ‡æ¢ï¼Œæ‚¬åœå³å¯æš‚åœ~", p:'chief'}],
            users: {} 
        };
        let me = { name:"", bio:"", p:0, gender:"boy", chances:1, inv:[], giftedTo: [] };
        let curSlide = 0;
        let selP = 0;
        let selG = "boy";
        let giftToGiveIdx = -1;
        let slideInterval = null;

        function init() {
            createSnow();
            renderTrees(); 
            renderChat();
            renderRank();
            updateSlides();
            startAutoSlide();
            // åˆå§‹åŒ–æ—¶ä¸å¼¹å‡ºæ³¨å†Œæ¡†ï¼Œç­‰å¾…è¿›å…¥
        }

        // æ–°å¢ï¼šè¿›å…¥æ‘åº„é€»è¾‘
        function enterVillage() {
            const landing = document.getElementById('landing-page');
            landing.classList.add('hidden');
            
            // å°è¯•æ’­æ”¾éŸ³ä¹ï¼ˆç”¨æˆ·äº¤äº’åæµè§ˆå™¨å…è®¸æ’­æ”¾ï¼‰
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-btn');
            bgm.play().then(() => {
                btn.classList.add('playing');
            }).catch(e => console.log("Autoplay prevented"));

            // æ˜¾ç¤ºæ³¨å†Œå¼¹çª—
            setTimeout(() => {
                document.getElementById('modal-reg').classList.add('active');
            }, 500);
        }

        function startAutoSlide() {
            if(slideInterval) clearInterval(slideInterval);
            slideInterval = setInterval(() => moveSlide(1), 4000);
        }
        function stopAutoSlide() { if(slideInterval) clearInterval(slideInterval); }
        
        function moveSlide(dir) {
            curSlide += dir;
            if(curSlide < 0) curSlide = 2;
            if(curSlide > 2) curSlide = 0;
            updateSlides();
        }

        function updateSlides() {
            const t = document.getElementById('tree-name-display');
            t.innerText = trees[curSlide].name;
            t.style.color = trees[curSlide].color;

            const slides = document.querySelectorAll('.tree-slide');
            slides.forEach((s, i) => {
                if(i === curSlide) s.classList.add('active');
                else s.classList.remove('active');
            });
        }

        function renderTrees() {
            const track = document.getElementById('track');
            track.innerHTML = '';
            
            trees.forEach((tree, tIdx) => {
                const slide = document.createElement('div');
                slide.className = 'tree-slide';
                if(tIdx === 0) slide.classList.add('active');

                let layersHTML = '';
                for(let i=1; i<=10; i++) layersHTML += `<div class="tree-layer l${i}"></div>`;
                
                let boxesHTML = `<div class="box-wrapper">`;
                for(let i=0; i<9; i++) {
                    const isOpen = state.opened[tIdx].includes(i);
                    const openClass = isOpen ? 'opened' : '';
                    const disableClass = (me.chances <= 0 && !isOpen) ? 'disabled' : '';
                    const style = `top:${boxPos[i].t}px; left:${boxPos[i].l}px;`;
                    
                    boxesHTML += `
                        <div class="box ${openClass} ${disableClass}" style="${style}" onclick="openBox(${tIdx}, ${i})">
                            <div class="bow"></div>
                        </div>
                    `;
                }
                boxesHTML += `</div>`;

                slide.innerHTML = `
                    <div class="tree-css ${tree.class}">
                        <div class="star-top">ğŸŒŸ</div>
                        ${layersHTML}
                        <div class="tree-stump"></div>
                        ${boxesHTML}
                    </div>
                `;
                track.appendChild(slide);
            });
        }

        function openBox(tIdx, bIdx) {
            if(!me.name) return;
            if(state.opened[tIdx].includes(bIdx)) return;
            
            if(me.chances <= 0) {
                alert("æ¬¡æ•°ç”¨å…‰å•¦ï¼");
                return;
            }

            state.opened[tIdx].push(bIdx);
            me.chances--;
            
            const gift = trees[tIdx].gifts[bIdx % trees[tIdx].gifts.length];
            if(gift.type === 'retry') me.chances++;

            const item = { i: gift.i, n: gift.n, from: me.name, to: me.name, type: 'draw' };
            me.inv.push(item);
            state.history.unshift({ ...item, p: me.p, time: Date.now() });
            
            addChat("æ‘é•¿", `${me.name} åœ¨ [${trees[tIdx].name}] æ‹†åˆ°äº† ${gift.i} ${gift.n}ï¼`, 'chief');

            saveState();
            renderTrees(); 
            updateSlides(); 
            renderRank();
            updateMyInfo();

            document.getElementById('prize-icon').innerText = gift.i;
            document.getElementById('prize-name').innerText = gift.n;
            document.getElementById('retry-hint').style.display = gift.type==='retry' ? 'block' : 'none';
            document.getElementById('modal-prize').classList.add('active');
        }

        function selAv(i) {
            selP = i;
            document.querySelectorAll('.av-select').forEach((el, idx) => {
                if(idx === i) el.classList.add('selected');
                else el.classList.remove('selected');
            });
        }
        function selGender(g) {
            selG = g;
            document.getElementById('g-boy').className = g==='boy'?'gender-opt selected':'gender-opt';
            document.getElementById('g-girl').className = g==='girl'?'gender-opt selected':'gender-opt';
        }
        
        function register() {
            const n = document.getElementById('inp-name').value.trim();
            if(!n) return;
            me.name = n;
            me.bio = document.getElementById('inp-bio').value.trim() || "è¿™å®¶ä¼™å¾ˆæ‡’";
            me.p = selP;
            me.gender = selG;
            me.giftedTo = [];
            
            state.users[me.name] = { bio: me.bio, p: me.p, gender: me.gender };
            saveState();
            document.getElementById('modal-reg').classList.remove('active');
            updateMyInfo();
            renderTrees(); 
            updateSlides();
            addChat("æ‘é•¿", `æ¬¢è¿æ–°æ‘æ°‘ ${me.name}ï¼`, 'chief');
        }

        function updateMyInfo() {
            document.getElementById('top-name').innerText = me.name;
            document.getElementById('top-avatar').className = `av-small p${me.p}`;
        }

        function renderChat() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            state.chats.forEach(c => {
                const row = document.createElement('div');
                const isChief = c.p === 'chief';
                row.className = isChief ? 'chat-row chief' : 'chat-row';
                
                const av = document.createElement('div');
                if(isChief) {
                    av.className = 'chat-av chief-av';
                    av.innerText = 'ğŸ…';
                } else {
                    av.className = `chat-av p${c.p}`;
                    av.onclick = () => showProfile(c.n);
                }
                
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                const nameHtml = isChief ? `<div class="chat-name">æ‘é•¿</div>` : `<div class="chat-name" onclick="showProfile('${c.n}')">${c.n}</div>`;
                bubble.innerHTML = `${nameHtml}${c.t}`;
                
                row.appendChild(av);
                row.appendChild(bubble);
                list.appendChild(row);
            });
            list.scrollTop = list.scrollHeight;
        }

        function sendChat() {
            const inp = document.getElementById('chat-inp');
            const txt = inp.value.trim();
            if(!txt || !me.name) return;
            addChat(me.name, txt, me.p);
            inp.value = '';
        }

        function addChat(n, t, p) {
            state.chats.push({n, t, p});
            if(state.chats.length > 50) state.chats.shift();
            saveState();
            renderChat();
        }

        function renderRank() {
            const list = document.getElementById('rank-list');
            list.innerHTML = '';
            state.history.forEach(h => {
                const el = document.createElement('div');
                el.className = 'rank-item';
                let txt = h.type === 'draw' ? `<span>${h.from}</span> æ‹†åˆ°äº† ${h.i} ${h.n}` : `<span>${h.from}</span> â” ${h.to} : ${h.i}`;
                el.innerHTML = `<div class="av-small p${h.p}"></div><div style="font-size:13px">${txt}</div>`;
                el.onclick = () => showProfile(h.from); 
                list.appendChild(el);
            });
        }

        function showProfile(name) {
            const isMe = (name === me.name);
            const user = isMe ? me : (state.users[name] || {bio:"æœªçŸ¥æ‘æ°‘", p:0, gender:"boy"});
            
            document.getElementById('prof-name').innerText = name;
            document.getElementById('prof-gender').innerText = user.gender === 'boy' ? 'ğŸ‘¦ ç”·ç”Ÿ' : 'ğŸ‘§ å¥³ç”Ÿ';
            document.getElementById('prof-bio').innerText = user.bio;
            document.getElementById('prof-av').className = `av-small p${user.p}`;
            
            const bagTitle = document.getElementById('prof-bag-title');
            if(isMe) bagTitle.innerText = "ğŸ’ æˆ‘çš„èƒŒåŒ…";
            else bagTitle.innerText = user.gender === 'boy' ? "ğŸ’ ä»–çš„èƒŒåŒ…" : "ğŸ’ å¥¹çš„èƒŒåŒ…";

            const bag = document.getElementById('prof-bag');
            bag.innerHTML = '';
            const items = isMe ? me.inv : state.history.filter(h => h.to === name).map(h => ({i:h.i, n:h.n}));
            
            if(items.length === 0) bag.innerHTML = '<div style="color:#aaa; font-size:12px;">èƒŒåŒ…ç©ºç©º</div>';
            else {
                items.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.style.background = 'rgba(0,0,0,0.1)'; div.style.padding = '5px'; div.style.fontSize = '12px';
                    div.innerHTML = `${item.i}<br>${item.n}`;
                    if(isMe) {
                        div.style.cursor = 'pointer'; div.title = 'èµ é€';
                        div.onclick = () => openGiveModal(idx);
                    }
                    bag.appendChild(div);
                });
            }
            document.getElementById('my-controls').style.display = isMe ? 'block' : 'none';
            if(isMe) document.getElementById('my-chances').innerText = me.chances;
            document.getElementById('modal-prof').classList.add('active');
        }
        function openMyProfile() { showProfile(me.name); }

        function openGiveModal(idx) {
            giftToGiveIdx = idx;
            document.getElementById('give-name').innerText = me.inv[idx].n;
            const list = document.getElementById('give-list');
            list.innerHTML = '';
            let users = new Set();
            state.chats.forEach(c => users.add(c.n));
            state.history.forEach(h => users.add(h.from));
            users.delete(me.name); users.delete("æ‘é•¿");
            if(users.size === 0) list.innerHTML = '<div style="padding:10px;color:#aaa">æš‚æ— æ´»è·ƒæ‘æ°‘...</div>';
            users.forEach(u => {
                const row = document.createElement('div');
                row.style.padding = '10px'; row.style.cursor = 'pointer'; row.innerText = `ğŸ‘¤ ${u}`;
                row.onclick = () => giveGift(u);
                list.appendChild(row);
            });
            closeModal('modal-prof');
            document.getElementById('modal-give').classList.add('active');
        }

        function giveGift(toUser) {
            if(me.giftedTo.includes(toUser)) {
                alert(`ä½ å·²ç»é€è¿‡ç¤¼ç‰©ç»™ ${toUser} å•¦ï¼æ¯äººåªèƒ½é€ä¸€æ¬¡å“¦~`);
                return;
            }

            const gift = me.inv.splice(giftToGiveIdx, 1)[0];
            const record = { i: gift.i, n: gift.n, from: me.name, to: toUser, type: 'give', p: me.p, time: Date.now() };
            state.history.unshift(record);
            
            me.giftedTo.push(toUser);
            me.chances++; 

            addChat("æ‘é•¿", `ğŸ ${me.name} æŠŠ [${gift.n}] é€ç»™äº† ${toUser}ï¼`, 'chief');
            saveState(); renderRank(); closeModal('modal-give');
            
            renderTrees();
            updateSlides(); 
            updateMyInfo();

            alert(`æˆåŠŸé€ç»™ ${toUser}ï¼\nä½ è·å¾—äº†ä¸€æ¬¡é¢å¤–çš„æŠ½å¥–æœºä¼šï¼å¿«å»çœ‹çœ‹æ ‘ä¸Šçš„ç¤¼ç‰©å§ï¼`);
        }

        function saveState() { localStorage.setItem('v18_state', JSON.stringify(state)); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function toggleBGM() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('bgm-btn');
            if(bgm.paused) {
                bgm.play();
                btn.classList.add('playing');
            } else {
                bgm.pause();
                btn.classList.remove('playing');
            }
        }

        function createSnow() {
            for(let i=0; i<80; i++) {
                const s = document.createElement('div');
                s.className = 'snowflake'; s.innerText = Math.random()>0.5 ? 'â„' : 'Â·';
                s.style.left = Math.random()*100+'vw'; s.style.fontSize = (Math.random()*15+5)+'px';
                s.style.animationDuration = (Math.random()*5+5)+'s'; s.style.animationDelay = Math.random()*15+'s';
                document.body.appendChild(s);
            }
        }

        init();
    </script>
</body>
</html>

<!-- Real-time chat sync via Yjs -->
    <script src="https://cdn.jsdelivr.net/npm/yjs@13.5.25/dist/yjs.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/y-websocket@1.4.5/dist/y-websocket.js"></script>
    <script>
    (function(){
        const ydoc = new Y.Doc();
        // connect to public yjs websocket server; room name for this app
        const provider = new Y.WebsocketProvider('wss://demos.yjs.dev', 'festive-village-live-chat', ydoc);
        const ychats = ydoc.getArray('chats');
        // initialize Y array with existing chats if empty
        if (ychats.length === 0) {
            ychats.push([state.chats]);
        } else {
            state.chats = ychats.toArray()[0];
            renderChat();
        }
        // observe remote updates
        ychats.observe(event => {
            const latest = ychats.toArray()[0];
            // update local state if different
            if (JSON.stringify(latest) !== JSON.stringify(state.chats)) {
                state.chats = latest;
                renderChat();
            }
        });
        // override addChat to sync to Yjs
        const oldAddChat = addChat;
        addChat = function(n, t, p) {
            oldAddChat(n, t, p);
            // push updated chats to Yjs
            ychats.delete(0, ychats.length);
            ychats.push([state.chats]);
        };
    })();
    </script>
</script>
